== [Exercise 6] Load-balancing

=== What you will learn

Participants will learn the basis for setting up a cluster in JBoss EAP 7 and how to JBoss EAP 7 as a load balancer. In this exercise the participant use Ansible to configure and setup the cluster. However this lab will not cover details about Ansible, nor is previous knowledge of Ansible required to run this lab.

=== Background information


=== Lab


Step 1 - Reviewing the ansible setup::
We are soon gonna use Ansible to configure the cluster in JBoss EAP 7, but before we kick-off the setup, let's review how the setup looks like.
+
Ansible playbooks describes how different host are assigned different roles. Roles are broken down into different tasks.
+
Because of limitations in the lab environment we are not going to use different different host, but instead we are going to configure a cluster in your local host.
+
Let's first investigate the playbook.
+
[source,yaml]
----
    - hosts: localhost
      roles:
        - jboss-eap-7
----
+
So your localhost will be assigned the role of jboss-eap-7. Let's investigate that as well.
+
[source,yaml]
----
- name: Extract JBoss EAP 7  # <1>
  unarchive: src={{jboss_zip_path}} dest={{ ansible_user_dir }} owner={{jboss_user}} group={{jboss_group}} creates={{jboss_home}} copy=no

- name: Create admin user for JBoss # <2>
  shell: "export JBOSS_HOME={{ jboss_home }}; {{ jboss_home }}/bin/add-user.sh -u admin -p {{ jboss_admin_password }} -s"

- name: Add demo application # <3>
  copy: src={{item}} dest={{ ansible_user_dir }} owner={{ jboss_user }} group={{ jboss_group }} mode=644
  with_items:
    - clustering-demo.war

- name: Add CLI configuration script # <4>
  template: src=mod-cluster.cli dest={{ ansible_user_dir }} owner={{ jboss_user }} group={{ jboss_group }} mode=644

- name: Apply configuration # <5>
  shell: "export JBOSS_HOME={{ jboss_home }}; {{ jboss_home }}/bin/jboss-cli.sh --file={{ ansible_user_dir }}/mod-cluster.cli"

----
<1> In this step the JBoss EAP 7 zip will be extracted, but only if it doesn't previously exists
<2> This task will create an administrative user.
<3> Adding the a WAR application
<4> In this step we will use the template feature of Ansible to add a CLI script
<5> In this step we execute the CLI script.



Step 2 - Review the CLI script::
As we can see the Ansible script extracts and adds a administrative user, and then the configuration is a applied via an CLI script.
+
Let's look at the most important things action in the CLI script,
+
[source,bash]
----
embed-host-controller # <1>

/profile=ha:clone(to-profile=backend) # <2>
/profile=default:clone(to-profile=load-balancer) # <3>

/profile=backend/subsystem=modcluster/mod-cluster-config=configuration:write-attribute(name=advertise-security-key, value=mypassword) # <4>


/profile=load-balancer/subsystem=undertow/configuration=filter/mod-cluster=modcluster:add(management-socket-binding=http, advertise-socket-binding=modcluster, security-key=mypassword) # <5>

# Add a server group called backend-servers
/server-group=backend-servers:add(profile=backend, socket-binding-group=ha-sockets) # <6>

# Add server config for backend1 and backend2 using 100 and 200 binding port offset.
/host=master/server-config=backend1:add(group=backend-servers, socket-binding-port-offset=100) # <7>
/host=master/server-config=backend2:add(group=backend-servers, socket-binding-port-offset=200) # <7>


# Add a modcluster filter to the undertow server that will use mulitcast to connect to backend servers
/profile=load-balancer/subsystem=undertow/server=default-server/host=default-host/filter-ref=modcluster:add
/socket-binding-group=standard-sockets/socket-binding=modcluster:add(multicast-port=23364, multicast-address=224.0.1.105) # <8>

# Add the load-balancer server group
/server-group=load-balancer:add(profile=load-balancer, socket-binding-group=standard-sockets # <9>

# Add a load-balancer server to the load-balancer group
/host=master/server-config=load-balancer:add(group=load-balancer) # <10>

# Deploy the  application to the serviers in the backend-server group
deploy {{ ansible_user_dir }}/clustering-demo.war --server-groups=backend-servers # <11>

----
<1> Starts an embedded host controller so that we can configure the domain without actually starting it. For standalone the same command is `embed-server`. This feature is called Off-line CLI and is new in JBoss EAP 7
<2> This command will clone the `ha` profile and create a new profile called `backend`. The backend servers will be based on `ha` profile since they are going to form a clusters
<3> We also clone the `default` profile to a new profile called `load-balancer` since the load-balancer is not part of the cluster.
<4> Configure the modcluster subsystem in the backend profile to use an advertise security key set to "mypassword"
<5> Adding the mod-cluster filter to the undertow subsystem and configuring the advertise security key to "mypassword"
<6> Create a server group called `backend-servers`
<7> Create servers `backend1` and `backend2` in the `backend-servers` server group.
<8> Add a modcluster filter to the undertow server that will use multicast to connect to backend servers
<9> Add the load-balancer server group
<10> Add a load-balancer server to the load-balancer group
<11> Deploy an application to the backend servers.

Step 3 - Execute the Ansible playbook::
To run the ansible playbook open a terminal window and go to the exercise directory and run the `ansible-playbook` command.
+
[source,bash]
----
$ cd exercise/projects/06_loadbalancing
$ ansible-playbook playbook.yml
----

Step 4 - Start the JBoss EAP 7 cluster::
To start the cluster is as simple as starting the standalone version, since Ansible helped us configure everything all we need to do is to go to the `$JBOSS_HOME/bin` and execute `domain.sh` instead of `standalone.sh`
+
[source,bash]
----
$ cd ~/jboss-eap-7.0/bin
$ sh domain.sh
----

Step 4 - Verify the application in a browser::
To verify the application open the following url in firefox http://localhost:8080/clustering-demo.
+
image::images/06_01_clustering-demo.png["",400]
+
Reload the page a couple of times and notices that the number of request increases, but that the backend-server is always the same. This is because our application is using sessions and mod_cluster is using session affinity (or sticky session).

Step 5 - High availability::
To test the high availability we can suspend the server that our session is connected to. In this step we will use backend-server1, but please you should use the same server that where listed in Step 4.
+
To suspend the server follow the below steps
+
. Open another tab to the admin console (http://localhost:9990)
. Login with username `admin` and password `admin-123`
. Click on `Runtime` tab
. Browse Domain by `Server Groups` -> `backend-servers` -> `backend1`
. Select `Suspend` from the drop down menu next to `backend1`
+
image::images/06_02_suspend_backend1.png["",600]
+
. Click on `Suspend Server`
+
image::images/06_03_suspend_server.png["",400]
. Reload the other firefox tab with the clustering-demo application
+
If everything worked correctly the backend server should now change and the counter should continue from and not restart.

Step 6 - Performance testing::




=== Summary

Brief summary around what we learned.


=== Links

For more information, please have a look at the following articles and documents:

* a
* b
* c
